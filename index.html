<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boulder Happy Hours</title>
    
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://boulderhappyhour.vercel.app/">
    <meta property="og:title" content="Boulder Happy Hours">
    <meta property="og:description" content="Find the best happy hour deals in Boulder County - food specials, drink deals, and late night offers">
    <meta property="og:image" content="https://boulderhappyhour.vercel.app/images/boulderhappyhour.jpg">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://boulderhappyhour.vercel.app/">
    <meta name="twitter:title" content="Boulder Happy Hours">
    <meta name="twitter:description" content="Find the best happy hour deals in Boulder County - food specials, drink deals, and late night offers">
    <meta name="twitter:image" content="https://boulderhappyhour.vercel.app/images/boulderhappyhour.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 to-amber-50 min-h-screen">
    <div id="root"></div>
    
    <script type="module">
        const React = await import('https://esm.sh/react@18.2.0');
        const ReactDOM = await import('https://esm.sh/react-dom@18.2.0/client');
        
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        const SHEET_ID = '1fOO4xaEGOmRbL1IYHl0YbU2acWxoksjfaJBm9uf4rp4';
        const SHEET_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
        
        const DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                if (values[0]) {
                    const deal = {
                        venue: values[0],
                        city: values[1] || '',
                        day: values[2] || '',
                        deal_type: values[3] || '',
                        time: values[4] || '',
                        deal_description: values[5] || '',
                        beer: (values[6] || '').toLowerCase().trim() === 'x',
                        wine: (values[7] || '').toLowerCase().trim() === 'x',
                        cocktail: (values[8] || '').toLowerCase().trim() === 'x',
                        margarita: (values[9] || '').toLowerCase().trim() === 'x',
                        nobo: (values[10] || '').toLowerCase().trim() === 'x',
                        sobo: (values[11] || '').toLowerCase().trim() === 'x',
                        dotobo: (values[12] || '').toLowerCase().trim() === 'x',
                        lesbo: (values[13] || '').toLowerCase().trim() === 'x',
                        thehill: (values[14] || '').toLowerCase().trim() === 'x',
                        central: (values[15] || '').toLowerCase().trim() === 'x',
                        latenight: (values[16] || '').toLowerCase().trim() === 'x'
                    };
                    
                    // Debug log for drinks with margarita tag
                    if (deal.margarita) {
                        console.log('Margarita deal found:', deal);
                    }
                    
                    result.push(deal);
                }
            }
            
            console.log('Total deals parsed:', result.length);
            console.log('All deals:', result);
            
            return result;
        }
        
        function App() {
            const [deals, setDeals] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // Filters
            const [selectedDay, setSelectedDay] = useState('');
            const [dealType, setDealType] = useState('all');
            const [drinkFilter, setDrinkFilter] = useState('all');
            const [lateNightOnly, setLateNightOnly] = useState(false);
            
            // Get current day
            useEffect(() => {
                const today = new Date().getDay();
                setSelectedDay(DAYS[today]);
            }, []);
            
            // Fetch data
            useEffect(() => {
                async function fetchDeals() {
                    try {
                        const response = await fetch(SHEET_CSV_URL);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const csvText = await response.text();
                        const parsedDeals = parseCSV(csvText);
                        
                        setDeals(parsedDeals);
                        setLoading(false);
                    } catch (err) {
                        console.error('Error fetching deals:', err);
                        setError('Failed to load deals. Please refresh the page.');
                        setLoading(false);
                    }
                }
                
                fetchDeals();
            }, []);
            
            // Filter deals
            const filteredDeals = deals.filter(deal => {
                const dealDay = deal.day.toLowerCase();
                const isWeekday = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].includes(selectedDay.toLowerCase());
                
                // When Late Night filter is active, ignore day filter and show all late night deals
                if (lateNightOnly) {
                    const timeStr = deal.time || '';
                    
                    // Check if this is a PM time by looking for "pm" in the string
                    const hasPM = timeStr.toLowerCase().includes('pm');
                    const hasAM = timeStr.toLowerCase().includes('am');
                    
                    // If it has AM only (no PM), it's definitely not late night
                    if (hasAM && !hasPM) {
                        return false;
                    }
                    
                    // If no PM indicator, not late night
                    if (!hasPM) {
                        return false;
                    }
                    
                    // Match time patterns - improved regex to capture AM/PM for each time
                    const timeMatch = timeStr.match(/(\d+)(?::(\d+))?\s*(am|pm|AM|PM)?[\s\-‚Äìto]+(\d+)?(?::(\d+))?\s*(am|pm|AM|PM)?/i);
                    
                    if (timeMatch) {
                        let startHour = parseInt(timeMatch[1]);
                        let startMin = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
                        const startPeriod = timeMatch[3] ? timeMatch[3].toLowerCase() : null;
                        const endHour = timeMatch[4] ? parseInt(timeMatch[4]) : null;
                        const endMin = timeMatch[5] ? parseInt(timeMatch[5]) : 0;
                        const endPeriod = timeMatch[6] ? timeMatch[6].toLowerCase() : null;
                        
                        // Convert start time to 24-hour format
                        if (startPeriod === 'pm' && startHour !== 12) {
                            startHour += 12;
                        } else if (startPeriod === 'am' && startHour === 12) {
                            startHour = 0;
                        }
                        
                        // If start time has AM, it's not late night
                        if (startPeriod === 'am') {
                            return false;
                        }
                        
                        // Convert end time to 24-hour format
                        let endHour24 = endHour;
                        if (endHour24) {
                            if (endPeriod === 'pm' && endHour24 !== 12) {
                                endHour24 += 12;
                            } else if (endPeriod === 'am' && endHour24 === 12) {
                                endHour24 = 0;
                            }
                        }
                        
                        // Check if deal runs during late night hours (at or after 8:00pm = 20:00)
                        // BUT exclude deals that END at exactly 8:00pm
                        const startTime = startHour * 60 + startMin; // Convert to minutes
                        const lateNightStart = 20 * 60; // 8:00pm in minutes
                        
                        const startsLateNight = startTime >= lateNightStart;
                        
                        let endsLateNight = false;
                        if (endHour24) {
                            const endTime = endHour24 * 60 + endMin;
                            // Must end AFTER 8:00pm, not AT 8:00pm
                            endsLateNight = endTime > lateNightStart;
                        }
                        
                        if (!startsLateNight && !endsLateNight) {
                            return false;
                        }
                        
                        // If we get here, it's a valid late night deal - accept it regardless of day
                        // Now apply other filters (deal type, drink type)
                        if (dealType !== 'all' && deal.deal_type !== dealType) return false;
                        
                        if (dealType === 'Drink' && drinkFilter !== 'all') {
                            if (drinkFilter === 'beer' && !deal.beer) return false;
                            if (drinkFilter === 'wine' && !deal.wine) return false;
                            if (drinkFilter === 'cocktail' && !deal.cocktail) return false;
                            if (drinkFilter === 'margarita' && !deal.margarita) return false;
                        }
                        
                        return true;
                    } else {
                        return false;
                    }
                }
                
                // Normal filtering when Late Night is NOT active
                // Handle different day types
                const matchesDay = 
                    deal.day === selectedDay || // Exact match
                    dealDay === 'daily' || // Daily deals show every day
                    (dealDay === 'weekdays' && isWeekday); // Weekdays deals show Mon-Fri only
                
                if (!matchesDay) return false;
                if (dealType !== 'all' && deal.deal_type !== dealType) return false;
                
                if (dealType === 'Drink' && drinkFilter !== 'all') {
                    if (drinkFilter === 'beer' && !deal.beer) return false;
                    if (drinkFilter === 'wine' && !deal.wine) return false;
                    if (drinkFilter === 'cocktail' && !deal.cocktail) return false;
                    if (drinkFilter === 'margarita' && !deal.margarita) return false;
                }
                
                return true;
            });
            
            // Group deals by venue when in "All" view
            let displayDeals;
            if (dealType === 'all') {
                // Group by venue + city
                const venueMap = new Map();
                filteredDeals.forEach(deal => {
                    const key = `${deal.venue}|${deal.city}`;
                    if (!venueMap.has(key)) {
                        venueMap.set(key, {
                            venue: deal.venue,
                            city: deal.city,
                            deals: []
                        });
                    }
                    venueMap.get(key).deals.push(deal);
                });
                displayDeals = Array.from(venueMap.values());
            } else {
                // Keep individual deals for Food/Drink view
                displayDeals = filteredDeals.map(deal => ({
                    venue: deal.venue,
                    city: deal.city,
                    deals: [deal]
                }));
            }
            
            // Sort deals within each venue by time
            displayDeals.forEach(venueGroup => {
                venueGroup.deals.sort((a, b) => {
                    const getStartTime = (timeStr) => {
                        if (!timeStr) return 24;
                        const match = timeStr.match(/(\d+)/);
                        return match ? parseInt(match[1]) : 24;
                    };
                    return getStartTime(a.time) - getStartTime(b.time);
                });
            });
            
            // Sort venues by earliest deal time
            const sortedDisplayDeals = displayDeals.sort((a, b) => {
                const getStartTime = (timeStr) => {
                    if (!timeStr) return 24;
                    const match = timeStr.match(/(\d+)/);
                    return match ? parseInt(match[1]) : 24;
                };
                const aTime = a.deals.length > 0 ? getStartTime(a.deals[0].time) : 24;
                const bTime = b.deals.length > 0 ? getStartTime(b.deals[0].time) : 24;
                return aTime - bTime;
            });
            
            if (loading) {
                return React.createElement('div', { className: 'flex items-center justify-center min-h-screen' },
                    React.createElement('div', { className: 'text-xl text-gray-600' }, 'Loading happy hours...')
                );
            }
            
            if (error) {
                return React.createElement('div', { className: 'flex items-center justify-center min-h-screen' },
                    React.createElement('div', { className: 'text-xl text-red-600' }, error)
                );
            }
            
            return React.createElement('div', { className: 'container mx-auto px-4 py-8 max-w-6xl' },
                // Header
                React.createElement('div', { className: 'text-center mb-8' },
                    React.createElement('h1', { className: 'text-5xl font-bold text-amber-900 mb-2' }, 'üçª Boulder Happy Hours'),
                    React.createElement('p', { className: 'text-lg text-gray-600 mb-4' }, 'Find the best deals in Boulder County'),
                    
                    // Results Count Pill Button
                    React.createElement('button', {
                        onClick: () => {
                            document.getElementById('deals-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        },
                        className: 'inline-block px-6 py-3 bg-white/70 backdrop-blur-md border border-amber-200 rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-105 cursor-pointer'
                    },
                        React.createElement('span', { className: 'font-semibold text-amber-800 text-lg' }, sortedDisplayDeals.length),
                        React.createElement('span', { className: 'text-gray-700 text-lg' }, ` ${dealType === 'all' ? 'venue' : 'deal'}${sortedDisplayDeals.length !== 1 ? 's' : ''} found for ${selectedDay}!`)
                    )
                ),
                
                // Day Filter
                React.createElement('div', { className: 'mb-6' },
                    React.createElement('div', { className: 'flex flex-wrap gap-2 justify-center' },
                        ...DAYS.map(day =>
                            React.createElement('button', {
                                key: day,
                                onClick: () => setSelectedDay(day),
                                className: `px-4 py-2 rounded-lg font-medium transition-all ${
                                    selectedDay === day
                                        ? 'bg-amber-600 text-white shadow-lg scale-105'
                                        : 'bg-white text-gray-700 hover:bg-amber-100'
                                }`
                            }, day)
                        )
                    )
                ),
                
                // Late Night Filter
                React.createElement('div', { className: 'mb-6' },
                    React.createElement('div', { className: 'flex gap-2 justify-center' },
                        React.createElement('button', {
                            onClick: () => setLateNightOnly(!lateNightOnly),
                            className: `px-6 py-2 rounded-lg font-medium transition-all relative overflow-hidden ${
                                lateNightOnly 
                                    ? 'bg-gradient-to-r from-indigo-900 to-purple-900 text-white shadow-lg scale-105' 
                                    : 'bg-gradient-to-r from-gray-800 to-gray-900 text-gray-300 hover:from-indigo-800 hover:to-purple-800 hover:text-white'
                            }`,
                            style: {
                                backgroundImage: lateNightOnly ? `
                                    radial-gradient(circle at 20% 30%, rgba(255,255,255,0.7) 1px, transparent 1px),
                                    radial-gradient(circle at 60% 70%, rgba(255,255,255,0.6) 1px, transparent 1px),
                                    radial-gradient(circle at 80% 20%, rgba(255,255,255,0.65) 1px, transparent 1px),
                                    radial-gradient(circle at 30% 80%, rgba(255,255,255,0.55) 1px, transparent 1px),
                                    radial-gradient(circle at 90% 60%, rgba(255,255,255,0.7) 1px, transparent 1px),
                                    radial-gradient(circle at 15% 50%, rgba(255,255,255,0.6) 1px, transparent 1px),
                                    radial-gradient(circle at 45% 15%, rgba(255,255,255,0.5) 1px, transparent 1px),
                                    radial-gradient(circle at 70% 45%, rgba(255,255,255,0.65) 1px, transparent 1px),
                                    linear-gradient(to right, rgb(49, 46, 129), rgb(88, 28, 135))
                                ` : `
                                    radial-gradient(circle at 20% 30%, rgba(255,255,255,0.45) 1px, transparent 1px),
                                    radial-gradient(circle at 60% 70%, rgba(255,255,255,0.38) 1px, transparent 1px),
                                    radial-gradient(circle at 80% 20%, rgba(255,255,255,0.42) 1px, transparent 1px),
                                    radial-gradient(circle at 30% 80%, rgba(255,255,255,0.36) 1px, transparent 1px),
                                    radial-gradient(circle at 90% 60%, rgba(255,255,255,0.45) 1px, transparent 1px),
                                    radial-gradient(circle at 15% 50%, rgba(255,255,255,0.4) 1px, transparent 1px),
                                    radial-gradient(circle at 45% 15%, rgba(255,255,255,0.35) 1px, transparent 1px),
                                    radial-gradient(circle at 70% 45%, rgba(255,255,255,0.42) 1px, transparent 1px),
                                    linear-gradient(to right, rgb(31, 41, 55), rgb(17, 24, 39))
                                `,
                                backgroundSize: '100% 100%'
                            }
                        }, 'üåõ Late Night')
                    )
                ),
                
                // Deal Type Toggle
                React.createElement('div', { className: 'mb-6' },
                    React.createElement('div', { className: 'flex gap-2 justify-center' },
                        React.createElement('button', {
                            onClick: () => { setDealType('all'); setDrinkFilter('all'); },
                            className: `px-6 py-2 rounded-lg font-medium transition-all ${
                                dealType === 'all' ? 'bg-gradient-to-br from-purple-500 via-purple-600 to-purple-800 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-purple-100'
                            }`
                        }, 'All'),
                        React.createElement('button', {
                            onClick: () => { setDealType('Food'); setDrinkFilter('all'); },
                            className: `px-6 py-2 rounded-lg font-medium transition-all ${
                                dealType === 'Food' ? 'bg-gradient-to-br from-green-500 via-green-600 to-green-800 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-green-100'
                            }`
                        }, 'üçï Food'),
                        React.createElement('button', {
                            onClick: () => setDealType('Drink'),
                            className: `px-6 py-2 rounded-lg font-medium transition-all ${
                                dealType === 'Drink' ? 'bg-gradient-to-br from-blue-500 via-blue-600 to-blue-800 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-blue-100'
                            }`
                        }, 'üç∫ Drink')
                    )
                ),
                dealType === 'Drink' && React.createElement('div', { className: 'mb-6' },
                    React.createElement('div', { className: 'flex flex-wrap gap-2 justify-center' },
                        React.createElement('button', {
                            onClick: () => setDrinkFilter('all'),
                            className: `px-4 py-2 rounded-lg font-medium transition-all ${
                                drinkFilter === 'all' ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-blue-100'
                            }`
                        }, 'All Drinks'),
                        React.createElement('button', {
                            onClick: () => setDrinkFilter('beer'),
                            className: `px-4 py-2 rounded-lg font-medium transition-all ${
                                drinkFilter === 'beer' ? 'bg-yellow-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-yellow-100'
                            }`
                        }, 'üç∫ Beer'),
                        React.createElement('button', {
                            onClick: () => setDrinkFilter('wine'),
                            className: `px-4 py-2 rounded-lg font-medium transition-all ${
                                drinkFilter === 'wine' ? 'bg-red-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-red-100'
                            }`
                        }, 'üç∑ Wine'),
                        React.createElement('button', {
                            onClick: () => setDrinkFilter('cocktail'),
                            className: `px-4 py-2 rounded-lg font-medium transition-all ${
                                drinkFilter === 'cocktail' ? 'bg-pink-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-pink-100'
                            }`
                        }, 'üç∏ Cocktails'),
                        React.createElement('button', {
                            onClick: () => setDrinkFilter('margarita'),
                            className: `px-4 py-2 rounded-lg font-medium transition-all ${
                                drinkFilter === 'margarita' ? 'bg-lime-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-lime-100'
                            }`
                        }, 'üçπ Margaritas')
                    )
                ),
                
                // Deals Grid
                React.createElement('div', { id: 'deals-section' },
                sortedDisplayDeals.length === 0
                    ? React.createElement('div', { className: 'text-center py-12 bg-white rounded-lg shadow' },
                        React.createElement('p', { className: 'text-xl text-gray-500' }, 'No deals found for this selection'),
                        React.createElement('p', { className: 'text-gray-400 mt-2' }, 'Try selecting a different day or filter')
                    )
                    : React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
                        ...sortedDisplayDeals.map((venueGroup, index) => {
                            const isAllView = dealType === 'all';
                            const hasMultipleDeals = venueGroup.deals.length > 1;
                            
                            return React.createElement('div', {
                                key: index,
                                className: 'bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow overflow-hidden'
                            },
                                // Card Header
                                React.createElement('div', {
                                    className: `p-4 ${
                                        isAllView
                                            ? 'bg-gradient-to-br from-purple-500 via-purple-600 to-purple-800'
                                            : venueGroup.deals[0].deal_type === 'Food'
                                                ? 'bg-gradient-to-br from-green-500 via-green-600 to-green-800'
                                                : 'bg-gradient-to-br from-blue-500 via-blue-600 to-blue-800'
                                    }`
                                },
                                    React.createElement('h3', { className: 'text-xl font-bold text-white mb-1' }, 
                                        venueGroup.venue
                                    ),
                                    React.createElement('p', { className: 'text-purple-50 text-sm' }, 
                                        (() => {
                                            const deal = venueGroup.deals[0];
                                            let neighborhood = '';
                                            if (deal.nobo) neighborhood = 'NoBo';
                                            else if (deal.sobo) neighborhood = 'SoBo';
                                            else if (deal.dotobo) neighborhood = 'DoToBoCo';
                                            else if (deal.lesbo) neighborhood = 'LesBo';
                                            else if (deal.thehill) neighborhood = 'The Hill';
                                            else if (deal.central) neighborhood = 'Central';
                                            
                                            return `üìç ${venueGroup.city}${neighborhood ? ` ‚Ä¢ üè° ${neighborhood}` : ''} ‚Ä¢ ‚è∞ ${deal.time}`;
                                        })()
                                    )
                                ),
                                
                                // Card Body - Loop through all deals for this venue
                                React.createElement('div', { className: 'p-4' },
                                    ...venueGroup.deals.map((deal, dealIndex) =>
                                        React.createElement('div', {
                                            key: dealIndex,
                                            className: dealIndex > 0 ? 'mt-4 pt-4 border-t border-gray-200' : ''
                                        },
                                            // Deal Type Badge (small, subtle)
                                            React.createElement('div', { className: 'mb-2' },
                                                React.createElement('span', {
                                                    className: `inline-block px-2 py-1 rounded text-xs font-medium ${
                                                        deal.deal_type === 'Food'
                                                            ? 'bg-green-100 text-green-800'
                                                            : 'bg-blue-100 text-blue-800'
                                                    }`
                                                }, deal.deal_type === 'Food' ? 'üçï Food' : 'üç∫ Drink')
                                            ),
                                            
                                            // Deal Description - PROMINENT
                                            React.createElement('p', { className: 'text-gray-700 text-base leading-relaxed mb-3 font-medium' }, deal.deal_description),
                                            
                                            // Tags - Late Night and Drink Types
                                            React.createElement('div', { className: 'flex gap-2 flex-wrap' },
                                                // Late Night Tag - same size as drink tags, lighter purple
                                                deal.latenight && React.createElement('span', { 
                                                    className: 'px-2 py-1 bg-gradient-to-r from-purple-100 to-indigo-200 text-purple-800 rounded text-xs font-medium'
                                                }, 'üåõ Late Night'),
                                                
                                                // Drink Tags (only show for Drink deals)
                                                deal.deal_type === 'Drink' && deal.beer && React.createElement('span', { className: 'px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-medium' }, 'üç∫ Beer'),
                                                deal.deal_type === 'Drink' && deal.wine && React.createElement('span', { className: 'px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-medium' }, 'üç∑ Wine'),
                                                deal.deal_type === 'Drink' && deal.cocktail && React.createElement('span', { className: 'px-2 py-1 bg-pink-100 text-pink-800 rounded text-xs font-medium' }, 'üç∏ Cocktail'),
                                                deal.deal_type === 'Drink' && deal.margarita && React.createElement('span', { className: 'px-2 py-1 bg-lime-100 text-lime-800 rounded text-xs font-medium' }, 'üçπ Margarita')
                                            )
                                        )
                                    )
                                )
                            );
                        })
                    )
                )
            );
        }
        
        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>